<!doctype html>
<html>
<head>
	<title>storyboard</title>
	<meta charset="utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/jquery-ui/jquery-ui.min.js"></script>
<!--<script src="js/jquery.ui.touch-punch.min.js"></script>-->
<!--<script src="js/jquery.mobile-1.4.5.min.js"></script>-->
<!--<script src="js/Sortable.min.js"></script>
  <script src="//rubaxa.github.io/Sortable/Sortable.js"></script>
-->
<link rel="stylesheet" href="js/jquery-ui/jquery-ui.min.css">
<script src='js/spectrum.js'></script>
<link rel='stylesheet' href='css/spectrum.css' />
<link rel="stylesheet" type="text/css" href="css/styles.css">
<!--<script src="js/md5.min.js"></script>-->

   
	<script>
        $(document).ready(function(){

       /*var loginScreen = function(){
            $('<div id="loginscreen">').appendTo('body');
            $('<form id="loginform"><div><label for="loginname">your name</label><input type="text" id="loginname"></div><div><label for="loginpass">... and the pass plz</label><input type="password" id="loginpass"></div><button id="loginbtn">login</button><p id="loginfail"></p></form>').appendTo('#loginscreen').fadeIn(1000);
            
        }
        loginScreen();

        var aUser = [
            {name:'seppi', pass:'hallo'}, 
            {name:'susi', pass:'nixgibts'}, 
            {name:'oliba', pass:'sers'}
            ];

        $('#loginform').on('keyup mouseup touchend', function(event){
            $('#loginfail').html('');

            if(event.keyCode === 13 || $('#loginbtn').on('click tap', true)) 
            {
            var name = $('#loginname').val();
            var pass = $('#loginpass').val();

            var user = new Object;
            user.pass = pass;
            user.name = name;
                if(aUser.indexOf(user) >= 1)
                {
                       $('#loginscreen').fadeOut();
                }
            }
            else {
                $('#loginfail').html('user oder pass nicht vorhanden');
            }
        })*/

        //--------------------------- login screen ende

        // -------- profile view / document selector -----------------------------

      /*var storyselector = function(){
           $('<div id="storyselector">').appendTo(body);

            if (localStorage.getItem(aStory[0]) == false)
            {
                var aStory = [];


            }

        }*/


        // ---- menu ------------------------------------------
  
        

            var createMenu = function(k){

                  var menuItem = function (pic, display) 
         {
            var _this = this; 
            _this.pic = pic;
            _this.display = display || 'none';
   /*         _this.longpress = function()

            { console.log('passt so', $(_this).parent())

                $(_this).parent().on('click touchstart', function()
                {
                    console.log('noch a bissl länga')
                    if(!triggered){
                        triggered = true;
                    setTimeout(function()
                    {
                        console.log('fost do')
                        triggered = false;
                        $(_this).css({'transform':'scale(1.5)'});
                    }, 500)}
                })
            }*/
            }

              var picArray = [
                'resources/pictures/menu.svg',
                'resources/pictures/icon.svg',
                'resources/pictures/003-signs-1.svg',
                'resources/pictures/001-file.svg',
                'resources/pictures/002-upload.svg',
                'resources/pictures/004-location.svg',
                'resources/pictures/005-signs.svg',
                'resources/pictures/left-alignment.svg',
                'resources/pictures/color-text.svg'
                ];

            var menuArray = [];

            var menulist = $('<ul>').appendTo('#menu');

            for (var j=0; j < picArray.length; j++) {                
                var newMenuEntry = new menuItem(picArray[j],'inline-block');
                menuArray.push(newMenuEntry);
            }



               for (let i = 0; i < k; i++) 
               {                                                        // wegen blockscoped von i für longpress effekt;
                menulist
                .append($('<li>')
                .css({backgroundImage:'url("' + menuArray[i].pic + '")', 'height':'2em', 'width':'2em'})
                .hide(0)
                .fadeIn(500)
                .attr('id', 'li'+i)
                );
                }; 

               /* var sortmenu = document.getElementById('menu');

                Sortable.create(sortmenu);
*/

            $('#li0').addClass('disabled');                 // disable draggin of sidemenu
            $('#li1').addClass('disabled').css({'width': '1em', 'margin': '1% 0 1% -1%'});     

            $('#menu ul')
            .sortable({appendTo: '#menu',
            containment: 'parent',
            cursor: "move",
            delay: 250,
            grid: [ 20, 20 ],
          //helper: "clone",
          items: 'li:not(.disabled)',
     //      items: "> li",
           placeholder: "sortable-placeholder",
            revert: 'true',
          //  tolerance: "intersect",
          //  forceHelperSize: true,
         
                });


                //submenu


                $('#li0').append('<ul id="submenu">');

                var submenu = $('#submenu');
        
                var submenuPicArray = [
                'resources/pictures/001-file.svg',
                'resources/pictures/002-upload.svg',
                ];

                
               for (let j = 0; j < submenuPicArray.length; j++) 
               {                                                        
                submenu
                .append($('<li>')
                .css({backgroundImage:'url("' + submenuPicArray[j] + '")', 'height':'2em', 'width':'2em', 'display':'block'})
                .hide()
                .fadeIn(500)
                .attr('id', 'subli'+j)
                );
                };

            }

            createMenu(8);
           


/* ------------------------------story ----------------------*/
  var oStory = function(title, story)
  {
      this.title = title;
      this.story = story;
      this.save = function(e){
          var timeStamp = Date.now;
          localStorage.setItem(title, story)
      };
      this.retrieve = function(e) {
        localStorage.getItem(e);
    }    
  };

//story selector screen
  
var aStory = [{name:'mei text', story:'<h1>HTML Ipsum Presents</h1><p><strong>Pellentesque habitant morbi tristique</strong> senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. <em>Aenean ultricies mi vitae est.</em> Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, <code>commodo vitae</code>, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. <a href="#">Donec non enim</a> in turpis pulvinar facilisis. Ut felis.</p><h2>Header Level 2</h2></br><ol> <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li><li>Aliquam tincidunt mauris eu risus.</li></ol><blockquote><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus magna. Cras in mi at felis aliquet congue. Ut a est eget ligula molestie gravida. Curabitur massa. Donec eleifend, libero at sagittis mollis, tellus est malesuada tellus, at luctus turpis elit sit amet quam. Vivamus pretium ornare est.</p></blockquote><h3>Header Level 3</h3><ul> <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li><li>Aliquam tincidunt mauris eu risus.</li></ul><pre><code>#header h1 a { display: block;  width: 300px;  height: 80px;}</code></pre>'}, 
               {name:'trappatoni', story:'Es gibt im Moment in diese Mannschaft, oh, einige Spieler vergessen ihnen Profi was sie sind. Ich lese nicht sehr viele Zeitungen, aber ich habe gehört viele Situationen. Erstens: wir haben nicht offensiv gespielt. Es gibt keine deutsche Mannschaft spielt offensiv und die Name offensiv wie Bayern. Letzte Spiel hatten wir in Platz drei Spitzen: Elber, Jancka und dann Zickler. Wir müssen nicht vergessen Zickler. Zickler ist eine Spitzen mehr, Mehmet eh mehr Basler. Ist klar diese Wörter, ist möglich verstehen, was ich hab gesagt? Danke. Offensiv, offensiv ist wie machen wir in Platz. Zweitens: ich habe erklärt mit diese zwei Spieler: nach Dortmund brauchen vielleicht Halbzeit Pause. Ich habe auch andere Mannschaften gesehen in Europa nach diese Mittwoch. Ich habe gesehen auch zwei Tage die Training. Ein Trainer ist nicht ein Idiot! Ein Trainer sei sehen was passieren in Platz. In diese Spiel es waren zwei, drei diese Spieler waren schwach wie eine Flasche leer! Haben Sie gesehen Mittwoch, welche Mannschaft hat gespielt Mittwoch? Hat gespielt Mehmet oder gespielt Basler oder hat gespielt Trapattoni? Diese Spieler beklagen mehr als sie spielen! Wissen Sie, warum die Italienmannschaften kaufen nicht diese Spieler? Weil wir haben gesehen viele Male solche Spiel! Haben'},
               {name: 'werther', story:'A wonderful serenity has taken possession of my entire soul, like these sweet mornings of spring which I enjoy with my whole heart. I am alone, and feel the charm of existence in this spot, which was created for the bliss of souls like mine. I am so happy, my dear friend, so absorbed in the exquisite sense of mere tranquil existence, that I neglect my talents. I should be incapable of drawing a single stroke at the present moment; and yet I feel that I never was a greater artist than now. When, while the lovely valley teems with vapour around me, and the meridian sun strikes the upper surface of the impenetrable foliage of my trees, and but a few stray gleams steal into the inner sanctuary, I throw myself down among the tall grass by the trickling stream; and, as I lie close to the earth, a thousand unknown plants are noticed by me: when I hear the buzz of the little world among the stalks, and grow familiar with the countless indescribable forms of the insects and flies, then I feel the presence of the Almighty, who formed us in his own image, and the breath '}];


var storyselector = function(){

    var currentStoryID = 0;


            $('#storywrapper').append('<div id="addstory" class="storypreview">+</div>');


            for (i in aStory) 
            {
            var storypreview = $('#storywrapper').append('<div class="storypreview" id="storyprev'+i+'">');
            $('#storyprev'+i).append('<h1>'+aStory[i].name+'</h1>').fadeIn()
            $('#storyprev'+i).append('<p>'+aStory[i].story.substr(0,200)+'</p>').fadeIn();
            }

            
     /*       
        $('#storyselector').on('click', function(){
            if (aStory == false){
                console.log ('aaaa')
                var newStory = new oStory('your Title', '');
                
                aStory.push(newStory);
          

          $('#storytitle').html(newStory.title);
          $('#storycontent').html(newStory.story);
          $('#storyselector').fadeOut();

          currentStoryID = aStory.indexOf(newStory);
      }
      else {
          $('#storytitle').html(aStory[currentStoryID].title);
          $('#storycontent').html(aStory[currentStoryID].story);
          $('#storyselector').fadeOut();

          console.log(aStory[0].title, aStory[0].story);

      }
  });*/

    $('.storypreview').on('click', function(){
        var previd = $(this).attr('id').slice(9);
                    console.log(aStory[previd].title, previd)
          
          $('#storytitle').html(aStory[previd].title);
          $('#storycontent').html(aStory[previd].story);
         //$('#storyselector').fadeOut();
         $('#storyselector').hide(0);
        });
    };                    // storyselector ende

 storyselector();


  $('#storycontent').on('keyup', function(e){
    var content = $('#storycontent').html()
    localStorage.setItem('abc', content)
    console.log('hh')
  });

  $('#testbtn').on('click', function(){
      var storyID = $('#storyquery').val();
      var stuff = localStorage.getItem(storyID, content);
      $('#storycontent').html(stuff);
  })


//------------------- get selection function -----------------------------

// stolen from quill


/*var Picker = function () {
  function Picker(select) {
    var _this = this;

    _classCallCheck(this, Picker);

    this.select = select;
    this.container = document.createElement('span');
    this.buildPicker();
    this.select.style.display = 'none';
    this.select.parentNode.insertBefore(this.container, this.select);
    this.label.addEventListener('mousedown', function () {
      _this.container.classList.toggle('ql-expanded');
    });
    this.select.addEventListener('change', this.update.bind(this));
  }*/
  
  

//------------------------------------------button actions -------------------------------------------------
            var selection = document.getSelection();

        $('#li3').on('click', function(){
            var parentName = document.getSelection().anchorNode.parentElement.nodeName.toLowerCase();
            var parentEle = document.getSelection().anchorNode.parentElement;

            if (selection.anchorNode === selection.focusNode){
            switch (parentName) {
            case 'p':
            case 'h1':
            case 'h2':
            case 'h3':
            case 'h4':
            case 'h5':
            case 'h6':
            case 'strong':
            case 'em':
            case 'b':
            
            {
                    $(parentEle).toggleClass('right_align');
                   break; 
            }

            case 'li':
            case 'code':
            case 'blockquote':
            case 'q': 
            {
                   $(parentEle).parent().toggleClass('right_align');
                   break;
            }         
        }}

        else {

           // $(selection.anchorNode).parentsUntil('#storycontent').toggleClass('right_align');
           // $(selection.focusNode).parentsUntil('#storycontent').toggleClass('right_align');

           var focusN = document.getSelection().focusNode;
           var anchorN = document.getSelection().anchorNode;
            
            console.log($(focusN).parent())
                $(focusN).parent().toggleClass('right_align');
                var nextN = $(focusN).next();
                        console.log(nextN)
                nextN.parentsUntil('#storycontent').toggleClass('right_align');           
        }
    });
    
    $('#li0').on('click', function(){

      /*  var menuheight = $('#menu ul'). attr('height');*/

        $("#menu ul").toggle(function(e){

            e.preventDefault;
            $(this).animate({height:'15em', display:'block'},200);
        },function(){
            $(this).animate({height:'5em',display:'block'},200);
        });

    /*    if(menuheight!='15em')
        {
            $('#menu ul').animate({'height': '15em'})
        }
        else
        {
            $('#menu ul').animate({'height': menuheight})
        }*/
        });


        
   $('#li5').on('click', function(){
 
         
         var sel = window.getSelection();
         var container = document.createElement("div");
         for (var i = 0, len = sel.rangeCount; i < len; ++i) {
            container.appendChild(sel.getRangeAt(i).cloneContents());
         }
         var sel_str_orig = container.innerHTML.trim();
        // alert((sel_str_orig.indexOf('<') === 0 ? sel_str_orig.indexOf('>') + 1 : 0)+" "+sel_str_orig);
        // alert(sel_str_orig.charAt(sel_str_orig.length - 1))
         
         //Index after the opening tags, if any exist or at index 0 otherwise du uschi.
         while(sel_str_orig.indexOf('<') === 0) 
            sel_str_orig = sel_str_orig.substr(sel_str_orig.indexOf('>') + 1).trim();                   
         //Index before the closing tags, if it exist or at the end otherwise du wirschtl
         while(sel_str_orig.charAt(sel_str_orig.length - 1) === '>') 
            sel_str_orig = sel_str_orig.substring(0,sel_str_orig.lastIndexOf('<')).trim();                     
         
        // alert(sel_str_orig); 
             
            
         var str = "";
         for(var i = 0; i < sel_str_orig.length;i++){
            
            var c = sel_str_orig.charAt(i);
            if(c == "<"){
              str += '</b>'+c;
            } else if(c == ">"){
               str += c+'<b>';
            } else {
               str += c; 
            }
         }
         str = '<b>'+str+'</b>';
         str = str.replace(/<b>\s*<\/b>/g,'');
         
        /*alert((sel_str_orig.match(/\//g) || []).length+"\n"+sel_str_orig+"\n"+str);
        alert( $('#storycontent').html().replace(
			      sel_str_orig, 
			      str));*/
	      $('#storycontent').html(
		      $('#storycontent').html().replace(
			      sel_str_orig, 
			      str));
	
            //alert($('#storycontent').hthtmlml().length);
            //console.log( 'first: ' + first, 'replaced: ' + replaced, first.indexOf('<b>'));
/*
            if (first.indexOf('<b>') > 0 && first.indexOf('</b>') < 0)
            {
                replaced = str.substring(start,ende)+'</b>';
                $('#storycontent').replaceWith('<div id="storycontent">' + first + replaced + last + '</div>');
            }
            else 
            {*/
                //$('#storycontent').replaceWith('<div id="storycontent">' + first + replaced + last + '</div>');
            

         /*   if(document.getSelection()){
            //$(focusN).insertBefore($('<strong>'));
            //$(anchorN).insertAfter($('</strong>'));
            }*/
     /*       $(selection)
                .contents()
                .filter(function() {
                    console.log(this.nodeType === 3) //Node.TEXT_NODE
                });*/
            });                 
        });  // DOM ready end

	</script>
	<style>
	</style>

</head>
<body>

<nav id="menu"></nav>
<div id="storytitle" contenteditable="true"></div>
<div id="storycontent" contenteditable="true"></div>
<!--<input type="text" id="storyquery"><button id="testbtn">load story</button>-->

<div id="storyselector"><div id="storywrapper"></div></div>



</body>
</html>
